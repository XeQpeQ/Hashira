local player = game:GetService("Players").LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")
local events = replicatedStorage.Package.Events
local data = replicatedStorage.Datas[player.UserId]

local Quest = {
    "Top X Fighter", "SSJB Wukong", "Citizen", "Kid Nohag", "Chilly", "X Fighter Trainer",
    "Super Vegetable", "Klirin", "SSJ2 Wukong", "Perfect Atom", "Radish", "Mapa",
    "Broccoli", "SSJG Kakata", "Kai-fist Master", "Kaio Student", "Turtle Student"
}

local MobTable = {}
local mobNamesAdded = {}

-- Llenar MobTable con nombres únicos de mobs
for _, mob in pairs(game:GetService("Workspace").Living:GetChildren()) do
    if not player:FindFirstChild(mob.Name) and not mobNamesAdded[mob.Name] then
        table.insert(MobTable, mob.Name)
        mobNamesAdded[mob.Name] = true
    end
end

-- Crear GUI programática
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "AutoFarmGUI"

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 300, 0, 250)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -125)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
mainFrame.BorderSizePixel = 0

local titleLabel = Instance.new("TextLabel", mainFrame)
titleLabel.Size = UDim2.new(1, 0, 0, 50)
titleLabel.Text = "AutoFarm GUI"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.BackgroundTransparency = 1
titleLabel.TextScaled = true

local autofarmToggle = Instance.new("TextButton", mainFrame)
autofarmToggle.Size = UDim2.new(1, -20, 0, 40)
autofarmToggle.Position = UDim2.new(0, 10, 0, 60)
autofarmToggle.Text = "Enable AutoFarm"
autofarmToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
autofarmToggle.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
autofarmToggle.BorderSizePixel = 0
autofarmToggle.TextScaled = true

local selectedMob = MobTable[1] or "None"
local selectedQuest = Quest[1] or "None"

-- Función para crear menú desplegable
local function createDropdown(labelText, options, initialSelection, positionY, callback)
    local label = Instance.new("TextLabel", mainFrame)
    label.Size = UDim2.new(1, -20, 0, 20)
    label.Position = UDim2.new(0, 10, 0, positionY)
    label.Text = labelText
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    
    local dropdown = Instance.new("TextButton", mainFrame)
    dropdown.Size = UDim2.new(1, -20, 0, 30)
    dropdown.Position = UDim2.new(0, 10, 0, positionY + 25)
    dropdown.Text = initialSelection
    dropdown.TextColor3 = Color3.fromRGB(255, 255, 255)
    dropdown.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
    dropdown.BorderSizePixel = 0
    dropdown.TextScaled = true

    local dropdownFrame = Instance.new("Frame", mainFrame)
    dropdownFrame.Size = UDim2.new(1, -20, 0, #options * 30)
    dropdownFrame.Position = UDim2.new(0, 10, 0, positionY + 60)
    dropdownFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    dropdownFrame.BorderSizePixel = 0
    dropdownFrame.Visible = false

    for i, option in ipairs(options) do
        local optionButton = Instance.new("TextButton", dropdownFrame)
        optionButton.Size = UDim2.new(1, 0, 0, 30)
        optionButton.Position = UDim2.new(0, 0, 0, (i - 1) * 30)
        optionButton.Text = option
        optionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        optionButton.BackgroundColor3 = Color3.fromRGB(55, 55, 55)
        optionButton.BorderSizePixel = 0
        optionButton.TextScaled = true

        optionButton.MouseButton1Click:Connect(function()
            dropdown.Text = option
            dropdownFrame.Visible = false
            callback(option)
        end)
    end

    dropdown.MouseButton1Click:Connect(function()
        dropdownFrame.Visible = not dropdownFrame.Visible
    end)

    return dropdown
end

-- Crear dropdowns
local mobDropdown = createDropdown("Select Mob", MobTable, selectedMob, 100, function(selected)
    selectedMob = selected
end)

local questDropdown = createDropdown("Select Quest", Quest, selectedQuest, 150, function(selected)
    selectedQuest = selected
end)

-- Toggle de AutoFarm
local autofarmEnabled = false
autofarmToggle.MouseButton1Click:Connect(function()
    autofarmEnabled = not autofarmEnabled
    getgenv().AutoFarm = autofarmEnabled
    autofarmToggle.Text = autofarmEnabled and "Disable AutoFarm" or "Enable AutoFarm"
end)

-- Función de búsqueda de Quest
local function quest()
    if replicatedStorage.Datas[player.UserId].Quest.Value ~= selectedQuest then
        local questNPC = game:GetService("Workspace").Others.NPCs:FindFirstChild(selectedQuest)
        if questNPC then
            player.Character.HumanoidRootPart.CFrame = questNPC.HumanoidRootPart.CFrame
            repeat
                wait()
                events.Qaction:InvokeServer(questNPC)
            until replicatedStorage.Datas[player.UserId].Quest.Value == selectedQuest
        end
    end
end

-- Bucle para activar el AutoFarm
task.spawn(function()
    while task.wait() do
        if autofarmEnabled then
            pcall(function()
                for _, mob in ipairs(game:GetService("Workspace").Living:GetChildren()) do
                    if mob.Name:lower() == selectedMob:lower() and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") and mob.Humanoid.Health > 0 then
                        repeat
                            quest()
                            player.Character.HumanoidRootPart.CFrame = mob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 2)
                            wait()
                            events.p:FireServer("Blacknwhite27", 1)
                        until not autofarmEnabled or not mob or mob.Humanoid.Health <= 0
                    end
                end
            end)
        end
    end
end)
